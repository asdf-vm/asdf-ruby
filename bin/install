#!/usr/bin/env bash

set -e
set -o pipefail

source "$(dirname "$0")/utils.sh"

fetch_patches() {
  local patches=$1

  while read -r line; do
    echo "$line"
    if [ "$line" = "" ]; then
      continue;
    fi

    if [[ "$line" =~ ^[Hh][Tt][Tt][Pp][Ss]?:// ]]; then
      echo "Using patch from URL: $line" >&2
      curl -fSs "$line" || exit 1
    else
      local abs_path=$(abspath "$line")
      echo "Using local patch: $abs_path" >&2
      cat "$abs_path" || exit 1
    fi
  done <<< "$patches"
}

install_ruby() {
  local install_type=$1
  local version=$2
  local install_path=$3

  if [ "$install_type" != "version" ]; then
    echoerr "Cannot install specific ref from source, sorry."
    echoerr "For a list of available versions, see \`asdf list-all ruby\`."
    exit 1
  fi

  echo "ruby-build $version $install_path"
  if [ -z "$RUBY_APPLY_PATCHES" ]; then
    $(ruby_build_path) "$version" "$install_path"
  else
    fetch_patches "$RUBY_APPLY_PATCHES" | $(ruby_build_path) --patch "$version" "$install_path"
  fi
}


install_default_gems() {
  local default_gems="$HOME/.default-gems"
  local gem="$ASDF_INSTALL_PATH/bin/gem"

  if [ ! -f "$default_gems" ]; then
    return;
  fi

  while read -r name; do
    echo -ne "\nInstalling gem ${name}... "

    if $gem install "$name" >/dev/null 2>&1; then
      echo -e "SUCCESS"
    else
      echo -e "FAIL"
    fi
  done < "$default_gems"
}

ensure_ruby_build_installed
install_ruby "$ASDF_INSTALL_TYPE" "$ASDF_INSTALL_VERSION" "$ASDF_INSTALL_PATH"
install_default_gems
